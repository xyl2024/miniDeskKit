<!-- Title: agentscope.model._anthropic_model - AgentScope -->
<!-- URL: https://doc.agentscope.io/zh_CN/_modules/agentscope/model/_anthropic_model.html -->

          <h1>agentscope.model._anthropic_model 源代码</h1><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># pylint: disable=too-many-branches, too-many-statements</span>
<span class="sd">"""The Anthropic API model classes."""</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">AsyncGenerator</span><span class="p">,</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Literal</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">._model_base</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatModelBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">._model_response</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">._model_usage</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatUsage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.._logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.._utils._common</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">_json_loads_with_repair</span><span class="p">,</span>
    <span class="n">_create_tool_from_base_model</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..message</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextBlock</span><span class="p">,</span> <span class="n">ToolUseBlock</span><span class="p">,</span> <span class="n">ThinkingBlock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..tracing</span><span class="w"> </span><span class="kn">import</span> <span class="n">trace_llm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..types._json</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONSerializableObject</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">anthropic.types.message</span><span class="w"> </span><span class="kn">import</span> <span class="n">Message</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">anthropic</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncStream</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">Message</span> <span class="o">=</span> <span class="s2">"anthropic.types.message.Message"</span>
    <span class="n">AsyncStream</span> <span class="o">=</span> <span class="s2">"anthropic.AsyncStream"</span>


<div class="viewcode-block" id="AnthropicChatModel">
<a class="viewcode-back" href="../../../api/agentscope.model.html#agentscope.model.AnthropicChatModel">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AnthropicChatModel</span><span class="p">(</span><span class="n">ChatModelBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""The Anthropic model wrapper for AgentScope."""</span>

<div class="viewcode-block" id="AnthropicChatModel.__init__">
<a class="viewcode-back" href="../../../api/agentscope.model.html#agentscope.model.AnthropicChatModel.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>
        <span class="n">stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">thinking</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">client_args</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">generate_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">JSONSerializableObject</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Initialize the Anthropic chat model.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_name (`str`):</span>
<span class="sd">                The model names.</span>
<span class="sd">            api_key (`str`):</span>
<span class="sd">                The anthropic API key.</span>
<span class="sd">            stream (`bool`):</span>
<span class="sd">                The streaming output or not</span>
<span class="sd">            max_tokens (`int`):</span>
<span class="sd">                Limit the maximum token count the model can generate.</span>
<span class="sd">            thinking (`dict | None`, default `None`):</span>
<span class="sd">                Configuration for Claude's internal reasoning process.</span>

<span class="sd">                .. code-block:: python</span>
<span class="sd">                    :caption: Example of thinking</span>

<span class="sd">                    {</span>
<span class="sd">                        "type": "enabled" | "disabled",</span>
<span class="sd">                        "budget_tokens": 1024</span>
<span class="sd">                    }</span>

<span class="sd">            client_args (`dict | None`, optional):</span>
<span class="sd">                The extra keyword arguments to initialize the Anthropic client.</span>
<span class="sd">            generate_kwargs (`dict[str, JSONSerializableObject] | None`, \</span>
<span class="sd">             optional):</span>
<span class="sd">                The extra keyword arguments used in Gemini API generation,</span>
<span class="sd">                e.g. `temperature`, `seed`.</span>
<span class="sd">        """</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">anthropic</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">"Please install the `anthropic` package by running "</span>
                <span class="s2">"`pip install anthropic`."</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">anthropic</span><span class="o">.</span><span class="n">AsyncAnthropic</span><span class="p">(</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
            <span class="o">**</span><span class="p">(</span><span class="n">client_args</span> <span class="ow">or</span> <span class="p">{}),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_tokens</span> <span class="o">=</span> <span class="n">max_tokens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thinking</span> <span class="o">=</span> <span class="n">thinking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_kwargs</span> <span class="o">=</span> <span class="n">generate_kwargs</span> <span class="ow">or</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="AnthropicChatModel.__call__">
<a class="viewcode-back" href="../../../api/agentscope.model.html#agentscope.model.AnthropicChatModel.__call__">[文档]</a>
    <span class="nd">@trace_llm</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"none"</span><span class="p">,</span> <span class="s2">"any"</span><span class="p">,</span> <span class="s2">"required"</span><span class="p">]</span>
        <span class="o">|</span> <span class="nb">str</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">structured_model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">generate_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span> <span class="o">|</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">ChatResponse</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Get the response from Anthropic chat completions API by the given</span>
<span class="sd">        arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            messages (`list[dict]`):</span>
<span class="sd">                A list of dictionaries, where `role` and `content` fields are</span>
<span class="sd">                required, and `name` field is optional.</span>
<span class="sd">            tools (`list[dict]`, default `None`):</span>
<span class="sd">                The tools JSON schemas that in format of:</span>

<span class="sd">                .. code-block:: python</span>
<span class="sd">                    :caption: Example of tools JSON schemas</span>

<span class="sd">                    [</span>
<span class="sd">                        {</span>
<span class="sd">                            "type": "function",</span>
<span class="sd">                            "function": {</span>
<span class="sd">                                "name": "xxx",</span>
<span class="sd">                                "description": "xxx",</span>
<span class="sd">                                "parameters": {</span>
<span class="sd">                                    "type": "object",</span>
<span class="sd">                                    "properties": {</span>
<span class="sd">                                        "param1": {</span>
<span class="sd">                                            "type": "string",</span>
<span class="sd">                                            "description": "..."</span>
<span class="sd">                                        },</span>
<span class="sd">                                        # Add more parameters as needed</span>
<span class="sd">                                    },</span>
<span class="sd">                                    "required": ["param1"]</span>
<span class="sd">                            }</span>
<span class="sd">                        },</span>
<span class="sd">                        # More schemas here</span>
<span class="sd">                    ]</span>

<span class="sd">            tool_choice (`Literal["auto", "none", "any", "required"] | str \</span>
<span class="sd">            | None`, default `None`):</span>
<span class="sd">                Controls which (if any) tool is called by the model.</span>
<span class="sd">                 Can be "auto", "none", "any", "required", or specific tool</span>
<span class="sd">                 name. For more details, please refer to</span>
<span class="sd">                 https://docs.anthropic.com/en/docs/agents-and-tools/tool-use/implement-tool-use</span>
<span class="sd">            structured_model (`Type[BaseModel] | None`, default `None`):</span>
<span class="sd">                A Pydantic BaseModel class that defines the expected structure</span>
<span class="sd">                for the model's output. When provided, the model will be forced</span>
<span class="sd">                to return data that conforms to this schema by automatically</span>
<span class="sd">                converting the BaseModel to a tool function and setting</span>
<span class="sd">                `tool_choice` to enforce its usage. This enables structured</span>
<span class="sd">                output generation.</span>

<span class="sd">                .. note:: When `structured_model` is specified,</span>
<span class="sd">                    both `tools` and `tool_choice` parameters are ignored,</span>
<span class="sd">                    and the model will only perform structured output</span>
<span class="sd">                    generation without calling any other tools.</span>

<span class="sd">            **generate_kwargs (`Any`):</span>
<span class="sd">                The keyword arguments for Anthropic chat completions API,</span>
<span class="sd">                e.g. `temperature`, `top_p`, etc. Please</span>
<span class="sd">                refer to the Anthropic API documentation for more details.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `ChatResponse | AsyncGenerator[ChatResponse, None]`:</span>
<span class="sd">                The response from the Anthropic chat completions API."""</span>

        <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"model"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
            <span class="s2">"max_tokens"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tokens</span><span class="p">,</span>
            <span class="s2">"stream"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_kwargs</span><span class="p">,</span>
            <span class="o">**</span><span class="n">generate_kwargs</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thinking</span> <span class="ow">and</span> <span class="s2">"thinking"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"thinking"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thinking</span>

        <span class="k">if</span> <span class="n">tools</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"tools"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_tools_json_schemas</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tool_choice</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_tool_choice</span><span class="p">(</span><span class="n">tool_choice</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"tool_choice"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_tool_choice</span><span class="p">(</span><span class="n">tool_choice</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">structured_model</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tools</span> <span class="ow">or</span> <span class="n">tool_choice</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">"structured_model is provided. Both 'tools' and "</span>
                    <span class="s2">"'tool_choice' parameters will be overridden and "</span>
                    <span class="s2">"ignored. The model will only perform structured output "</span>
                    <span class="s2">"generation without calling any other tools."</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">format_tool</span> <span class="o">=</span> <span class="n">_create_tool_from_base_model</span><span class="p">(</span><span class="n">structured_model</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"tools"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_tools_json_schemas</span><span class="p">(</span>
                <span class="p">[</span><span class="n">format_tool</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"tool_choice"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_tool_choice</span><span class="p">(</span>
                <span class="n">format_tool</span><span class="p">[</span><span class="s2">"function"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Extract the system message</span>
        <span class="k">if</span> <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"role"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"system"</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"system"</span><span class="p">]</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"content"</span><span class="p">]</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s2">"messages"</span><span class="p">]</span> <span class="o">=</span> <span class="n">messages</span>

        <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_anthropic_stream_completion_response</span><span class="p">(</span>
                <span class="n">start_datetime</span><span class="p">,</span>
                <span class="n">response</span><span class="p">,</span>
                <span class="n">structured_model</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Non-streaming response</span>
        <span class="n">parsed_response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_anthropic_completion_response</span><span class="p">(</span>
            <span class="n">start_datetime</span><span class="p">,</span>
            <span class="n">response</span><span class="p">,</span>
            <span class="n">structured_model</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">parsed_response</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_parse_anthropic_completion_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_datetime</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">Message</span><span class="p">,</span>
        <span class="n">structured_model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Given an Anthropic Message object, extract the content blocks and</span>
<span class="sd">        usages from it.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_datetime (`datetime`):</span>
<span class="sd">                The start datetime of the response generation.</span>
<span class="sd">            response (`Message`):</span>
<span class="sd">                Anthropic Message object to parse.</span>
<span class="sd">            structured_model (`Type[BaseModel] | None`, default `None`):</span>
<span class="sd">                A Pydantic BaseModel class that defines the expected structure</span>
<span class="sd">                for the model's output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ChatResponse (`ChatResponse`):</span>
<span class="sd">                A ChatResponse object containing the content blocks and usage.</span>

<span class="sd">        .. note::</span>
<span class="sd">            If `structured_model` is not `None`, the expected structured output</span>
<span class="sd">            will be stored in the metadata of the `ChatResponse`.</span>
<span class="sd">        """</span>
        <span class="n">content_blocks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ThinkingBlock</span> <span class="o">|</span> <span class="n">TextBlock</span> <span class="o">|</span> <span class="n">ToolUseBlock</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">"content"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">content_block</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">content_block</span><span class="p">,</span> <span class="s2">"type"</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">content_block</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"thinking"</span>
                <span class="p">):</span>
                    <span class="n">thinking_block</span> <span class="o">=</span> <span class="n">ThinkingBlock</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">"thinking"</span><span class="p">,</span>
                        <span class="n">thinking</span><span class="o">=</span><span class="n">content_block</span><span class="o">.</span><span class="n">thinking</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">thinking_block</span><span class="p">[</span><span class="s2">"signature"</span><span class="p">]</span> <span class="o">=</span> <span class="n">content_block</span><span class="o">.</span><span class="n">signature</span>
                    <span class="n">content_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thinking_block</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">content_block</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">):</span>
                    <span class="n">content_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">TextBlock</span><span class="p">(</span>
                            <span class="nb">type</span><span class="o">=</span><span class="s2">"text"</span><span class="p">,</span>
                            <span class="n">text</span><span class="o">=</span><span class="n">content_block</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                <span class="k">elif</span> <span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">content_block</span><span class="p">,</span> <span class="s2">"type"</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">content_block</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"tool_use"</span>
                <span class="p">):</span>
                    <span class="n">content_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">ToolUseBlock</span><span class="p">(</span>
                            <span class="nb">type</span><span class="o">=</span><span class="s2">"tool_use"</span><span class="p">,</span>
                            <span class="nb">id</span><span class="o">=</span><span class="n">content_block</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">content_block</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="nb">input</span><span class="o">=</span><span class="n">content_block</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">structured_model</span><span class="p">:</span>
                        <span class="n">metadata</span> <span class="o">=</span> <span class="n">content_block</span><span class="o">.</span><span class="n">input</span>

        <span class="n">usage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="p">:</span>
            <span class="n">usage</span> <span class="o">=</span> <span class="n">ChatUsage</span><span class="p">(</span>
                <span class="n">input_tokens</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">input_tokens</span><span class="p">,</span>
                <span class="n">output_tokens</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">output_tokens</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_datetime</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span>
            <span class="p">)</span>

        <span class="n">parsed_response</span> <span class="o">=</span> <span class="n">ChatResponse</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">content_blocks</span><span class="p">,</span>
            <span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">parsed_response</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_parse_anthropic_stream_completion_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_datetime</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">AsyncStream</span><span class="p">,</span>
        <span class="n">structured_model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">ChatResponse</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Given an Anthropic streaming response, extract the content blocks</span>
<span class="sd">        and usages from it and yield ChatResponse objects.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_datetime (`datetime`):</span>
<span class="sd">                The start datetime of the response generation.</span>
<span class="sd">            response (`AsyncStream`):</span>
<span class="sd">                Anthropic AsyncStream object to parse.</span>
<span class="sd">            structured_model (`Type[BaseModel] | None`, default `None`):</span>
<span class="sd">                A Pydantic BaseModel class that defines the expected structure</span>
<span class="sd">                for the model's output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `AsyncGenerator[ChatResponse, None]`:</span>
<span class="sd">                An async generator that yields ChatResponse objects containing</span>
<span class="sd">                the content blocks and usage information for each chunk in</span>
<span class="sd">                the streaming response.</span>

<span class="sd">        .. note::</span>
<span class="sd">            If `structured_model` is not `None`, the expected structured output</span>
<span class="sd">            will be stored in the metadata of the `ChatResponse`.</span>
<span class="sd">        """</span>

        <span class="n">usage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">text_buffer</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="n">thinking_buffer</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="n">thinking_signature</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="n">tool_calls</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">tool_call_buffers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">content_changed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">thinking_changed</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"message_start"</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span>
                <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">usage</span><span class="p">:</span>
                    <span class="n">usage</span> <span class="o">=</span> <span class="n">ChatUsage</span><span class="p">(</span>
                        <span class="n">input_tokens</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">input_tokens</span><span class="p">,</span>
                        <span class="n">output_tokens</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span>
                            <span class="n">message</span><span class="o">.</span><span class="n">usage</span><span class="p">,</span>
                            <span class="s2">"output_tokens"</span><span class="p">,</span>
                            <span class="mi">0</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_datetime</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span>
                    <span class="p">)</span>

            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"content_block_start"</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">content_block</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"tool_use"</span><span class="p">:</span>
                    <span class="n">block_index</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">index</span>
                    <span class="n">tool_block</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">content_block</span>
                    <span class="n">tool_calls</span><span class="p">[</span><span class="n">block_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"tool_use"</span><span class="p">,</span>
                        <span class="s2">"id"</span><span class="p">:</span> <span class="n">tool_block</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">"name"</span><span class="p">:</span> <span class="n">tool_block</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="s2">"input"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">tool_call_buffers</span><span class="p">[</span><span class="n">block_index</span><span class="p">]</span> <span class="o">=</span> <span class="s2">""</span>
                    <span class="n">content_changed</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"content_block_delta"</span><span class="p">:</span>
                <span class="n">block_index</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">index</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">delta</span>
                <span class="k">if</span> <span class="n">delta</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"text_delta"</span><span class="p">:</span>
                    <span class="n">text_buffer</span> <span class="o">+=</span> <span class="n">delta</span><span class="o">.</span><span class="n">text</span>
                    <span class="n">content_changed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">delta</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"thinking_delta"</span><span class="p">:</span>
                    <span class="n">thinking_buffer</span> <span class="o">+=</span> <span class="n">delta</span><span class="o">.</span><span class="n">thinking</span>
                    <span class="n">thinking_changed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">delta</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"signature_delta"</span><span class="p">:</span>
                    <span class="n">thinking_signature</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">signature</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">delta</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"input_json_delta"</span>
                    <span class="ow">and</span> <span class="n">block_index</span> <span class="ow">in</span> <span class="n">tool_calls</span>
                <span class="p">):</span>
                    <span class="n">tool_call_buffers</span><span class="p">[</span><span class="n">block_index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span><span class="o">.</span><span class="n">partial_json</span> <span class="ow">or</span> <span class="s2">""</span>
                    <span class="n">tool_calls</span><span class="p">[</span><span class="n">block_index</span><span class="p">][</span><span class="s2">"input"</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_call_buffers</span><span class="p">[</span>
                        <span class="n">block_index</span>
                    <span class="p">]</span>
                    <span class="n">content_changed</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"message_delta"</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">usage</span> <span class="ow">and</span> <span class="n">usage</span><span class="p">:</span>
                    <span class="n">usage</span><span class="o">.</span><span class="n">output_tokens</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">output_tokens</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">thinking_changed</span> <span class="ow">or</span> <span class="n">content_changed</span><span class="p">)</span> <span class="ow">and</span> <span class="n">usage</span><span class="p">:</span>
                <span class="n">contents</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">thinking_buffer</span><span class="p">:</span>
                    <span class="n">thinking_block</span> <span class="o">=</span> <span class="n">ThinkingBlock</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">"thinking"</span><span class="p">,</span>
                        <span class="n">thinking</span><span class="o">=</span><span class="n">thinking_buffer</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">thinking_block</span><span class="p">[</span><span class="s2">"signature"</span><span class="p">]</span> <span class="o">=</span> <span class="n">thinking_signature</span>
                    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thinking_block</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">text_buffer</span><span class="p">:</span>
                    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">TextBlock</span><span class="p">(</span>
                            <span class="nb">type</span><span class="o">=</span><span class="s2">"text"</span><span class="p">,</span>
                            <span class="n">text</span><span class="o">=</span><span class="n">text_buffer</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">block_index</span><span class="p">,</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">input_str</span> <span class="o">=</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">"input"</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">input_obj</span> <span class="o">=</span> <span class="n">_json_loads_with_repair</span><span class="p">(</span><span class="n">input_str</span> <span class="ow">or</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">input_obj</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">input_obj</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">ToolUseBlock</span><span class="p">(</span>
                            <span class="nb">type</span><span class="o">=</span><span class="n">tool_call</span><span class="p">[</span><span class="s2">"type"</span><span class="p">],</span>
                            <span class="nb">id</span><span class="o">=</span><span class="n">tool_call</span><span class="p">[</span><span class="s2">"id"</span><span class="p">],</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">tool_call</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span>
                            <span class="nb">input</span><span class="o">=</span><span class="n">input_obj</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">structured_model</span><span class="p">:</span>
                        <span class="n">metadata</span> <span class="o">=</span> <span class="n">input_obj</span>
                <span class="k">if</span> <span class="n">contents</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">ChatResponse</span><span class="p">(</span>
                        <span class="n">content</span><span class="o">=</span><span class="n">contents</span><span class="p">,</span>
                        <span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">yield</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_tools_json_schemas</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">schemas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Format the JSON schemas of the tool functions to the format that</span>
<span class="sd">        Anthropic API expects."""</span>
        <span class="n">formatted_schemas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">schemas</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="s2">"function"</span> <span class="ow">in</span> <span class="n">schema</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">"Invalid schema: </span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">, expect key 'function'."</span>

            <span class="k">assert</span> <span class="s2">"name"</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="s2">"function"</span><span class="p">],</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Invalid schema: </span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">, "</span>
                <span class="s2">"expect key 'name' in 'function' field."</span>
            <span class="p">)</span>

            <span class="n">formatted_schemas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">"name"</span><span class="p">:</span> <span class="n">schema</span><span class="p">[</span><span class="s2">"function"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">],</span>
                    <span class="s2">"description"</span><span class="p">:</span> <span class="n">schema</span><span class="p">[</span><span class="s2">"function"</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"description"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span>
                    <span class="s2">"input_schema"</span><span class="p">:</span> <span class="n">schema</span><span class="p">[</span><span class="s2">"function"</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"parameters"</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">formatted_schemas</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_tool_choice</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"none"</span><span class="p">,</span> <span class="s2">"any"</span><span class="p">,</span> <span class="s2">"required"</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Format tool_choice parameter for API compatibility.</span>

<span class="sd">        Args:</span>
<span class="sd">            tool_choice (`Literal["auto", "none", "any", "required"] | str \</span>
<span class="sd">                | None`, default `None`):</span>
<span class="sd">                Controls which (if any) tool is called by the model.</span>
<span class="sd">                 Can be "auto", "none", "any", "required", or specific tool</span>
<span class="sd">                 name. For more details, please refer to</span>
<span class="sd">                 https://docs.anthropic.com/en/docs/agents-and-tools/tool-use/implement-tool-use</span>
<span class="sd">        Returns:</span>
<span class="sd">            `dict | None`:</span>
<span class="sd">                The formatted tool choice configuration dict, or None if</span>
<span class="sd">                tool_choice is None.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">tool_choice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">type_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"auto"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"auto"</span><span class="p">},</span>
            <span class="s2">"none"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"none"</span><span class="p">},</span>
            <span class="s2">"any"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"any"</span><span class="p">},</span>
            <span class="s2">"required"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"any"</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">tool_choice</span> <span class="ow">in</span> <span class="n">type_mapping</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">type_mapping</span><span class="p">[</span><span class="n">tool_choice</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"tool"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="n">tool_choice</span><span class="p">}</span></div>

</pre></div>
        