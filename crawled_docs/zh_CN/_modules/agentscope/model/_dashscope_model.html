<!-- Title: agentscope.model._dashscope_model - AgentScope -->
<!-- URL: https://doc.agentscope.io/zh_CN/_modules/agentscope/model/_dashscope_model.html -->

          <h1>agentscope.model._dashscope_model 源代码</h1><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">"""The dashscope API model classes."""</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">collections</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPStatus</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">AsyncGenerator</span><span class="p">,</span>
    <span class="n">Generator</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Literal</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aioitertools</span><span class="w"> </span><span class="kn">import</span> <span class="nb">iter</span> <span class="k">as</span> <span class="n">giter</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">._model_base</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatModelBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">._model_response</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">._model_usage</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatUsage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.._utils._common</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">_json_loads_with_repair</span><span class="p">,</span>
    <span class="n">_create_tool_from_base_model</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..message</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextBlock</span><span class="p">,</span> <span class="n">ToolUseBlock</span><span class="p">,</span> <span class="n">ThinkingBlock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..tracing</span><span class="w"> </span><span class="kn">import</span> <span class="n">trace_llm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..types</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONSerializableObject</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.._logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">dashscope.api_entities.dashscope_response</span><span class="w"> </span><span class="kn">import</span> <span class="n">GenerationResponse</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">dashscope.api_entities.dashscope_response</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">MultiModalConversationResponse</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">GenerationResponse</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"dashscope.api_entities.dashscope_response.GenerationResponse"</span>
    <span class="p">)</span>
    <span class="n">MultiModalConversationResponse</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"dashscope.api_entities.dashscope_response."</span>
        <span class="s2">"MultiModalConversationResponse"</span>
    <span class="p">)</span>


<div class="viewcode-block" id="DashScopeChatModel">
<a class="viewcode-back" href="../../../api/agentscope.model.html#agentscope.model.DashScopeChatModel">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DashScopeChatModel</span><span class="p">(</span><span class="n">ChatModelBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""The DashScope chat model class, which unifies the Generation and</span>
<span class="sd">    MultimodalConversation APIs into one method."""</span>

<div class="viewcode-block" id="DashScopeChatModel.__init__">
<a class="viewcode-back" href="../../../api/agentscope.model.html#agentscope.model.DashScopeChatModel.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">enable_thinking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">generate_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">JSONSerializableObject</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_http_api_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Initialize the DashScope chat model.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_name (`str`):</span>
<span class="sd">                The model names.</span>
<span class="sd">            api_key (`str`):</span>
<span class="sd">                The dashscope API key.</span>
<span class="sd">            stream (`bool`):</span>
<span class="sd">                The streaming output or not</span>
<span class="sd">            enable_thinking (`bool | None`, optional):</span>
<span class="sd">                Enable thinking or not, only support Qwen3, QwQ, DeepSeek-R1.</span>
<span class="sd">                Refer to `DashScope documentation</span>
<span class="sd">                &lt;https://help.aliyun.com/zh/model-studio/deep-thinking&gt;`_</span>
<span class="sd">                for more details.</span>
<span class="sd">            generate_kwargs (`dict[str, JSONSerializableObject] | None`, \</span>
<span class="sd">            optional):</span>
<span class="sd">               The extra keyword arguments used in DashScope API generation,</span>
<span class="sd">               e.g. `temperature`, `seed`.</span>
<span class="sd">            base_http_api_url (`str | None`, optional):</span>
<span class="sd">                The base URL for DashScope API requests. If not provided,</span>
<span class="sd">                the default base URL from the DashScope SDK will be used.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">enable_thinking</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"In DashScope API, `stream` must be True when "</span>
                <span class="s2">"`enable_thinking` is True. "</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_thinking</span> <span class="o">=</span> <span class="n">enable_thinking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_kwargs</span> <span class="o">=</span> <span class="n">generate_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">base_http_api_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">dashscope</span>

            <span class="n">dashscope</span><span class="o">.</span><span class="n">base_http_api_url</span> <span class="o">=</span> <span class="n">base_http_api_url</span></div>


<div class="viewcode-block" id="DashScopeChatModel.__call__">
<a class="viewcode-back" href="../../../api/agentscope.model.html#agentscope.model.DashScopeChatModel.__call__">[文档]</a>
    <span class="nd">@trace_llm</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"none"</span><span class="p">,</span> <span class="s2">"any"</span><span class="p">,</span> <span class="s2">"required"</span><span class="p">]</span>
        <span class="o">|</span> <span class="nb">str</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">structured_model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span> <span class="o">|</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">ChatResponse</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Get the response from the dashscope</span>
<span class="sd">        Generation/MultimodalConversation API by the given arguments.</span>

<span class="sd">        .. note:: We unify the dashscope generation and multimodal conversation</span>
<span class="sd">         APIs into one method, since they support similar arguments and share</span>
<span class="sd">         the same functionality.</span>

<span class="sd">        Args:</span>
<span class="sd">            messages (`list[dict[str, Any]]`):</span>
<span class="sd">                A list of dictionaries, where `role` and `content` fields are</span>
<span class="sd">                required.</span>
<span class="sd">            tools (`list[dict] | None`, default `None`):</span>
<span class="sd">                The tools JSON schemas that the model can use.</span>
<span class="sd">            tool_choice (`Literal["auto", "none", "any", "required"] | str \</span>
<span class="sd">             |  None`,  default `None`):</span>
<span class="sd">                Controls which (if any) tool is called by the model.</span>
<span class="sd">                 Can be "auto", "none", or specific tool name.</span>
<span class="sd">                 For more details, please refer to</span>
<span class="sd">                 https://help.aliyun.com/zh/model-studio/qwen-function-calling</span>
<span class="sd">            structured_model (`Type[BaseModel] | None`, default `None`):</span>
<span class="sd">                A Pydantic BaseModel class that defines the expected structure</span>
<span class="sd">                for the model's output. When provided, the model will be forced</span>
<span class="sd">                to return data that conforms to this schema by automatically</span>
<span class="sd">                converting the BaseModel to a tool function and setting</span>
<span class="sd">                `tool_choice` to enforce its usage. This enables structured</span>
<span class="sd">                output generation.</span>

<span class="sd">                .. note:: When `structured_model` is specified,</span>
<span class="sd">                    both `tools` and `tool_choice` parameters are ignored,</span>
<span class="sd">                    and the model will only perform structured output</span>
<span class="sd">                    generation without calling any other tools.</span>

<span class="sd">            **kwargs (`Any`):</span>
<span class="sd">                The keyword arguments for DashScope chat completions API,</span>
<span class="sd">                e.g. `temperature`, `max_tokens`, `top_p`, etc. Please</span>
<span class="sd">                refer to `DashScope documentation</span>
<span class="sd">                &lt;https://help.aliyun.com/zh/dashscope/developer-reference/api-details&gt;`_</span>
<span class="sd">                for more detailed arguments.</span>
<span class="sd">        """</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">dashscope</span>

        <span class="c1"># For qvq and qwen-vl models, the content field cannot be `None` or</span>
        <span class="c1"># `[{"text": None}]`, so we need to convert it to an empty list.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"qvq"</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">"-vl"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s2">"content"</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">msg</span><span class="p">[</span><span class="s2">"content"</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">"text"</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                <span class="p">]:</span>
                    <span class="n">msg</span><span class="p">[</span><span class="s2">"content"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"messages"</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
            <span class="s2">"model"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
            <span class="s2">"stream"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_kwargs</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="s2">"result_format"</span><span class="p">:</span> <span class="s2">"message"</span><span class="p">,</span>
            <span class="c1"># In agentscope, the `incremental_output` must be `True` when</span>
            <span class="c1"># `self.stream` is True</span>
            <span class="s2">"incremental_output"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">tools</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"tools"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_tools_json_schemas</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tool_choice</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_tool_choice</span><span class="p">(</span><span class="n">tool_choice</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"tool_choice"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_tool_choice</span><span class="p">(</span><span class="n">tool_choice</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable_thinking</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="s2">"enable_thinking"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span>
        <span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"enable_thinking"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_thinking</span>

        <span class="k">if</span> <span class="n">structured_model</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tools</span> <span class="ow">or</span> <span class="n">tool_choice</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">"structured_model is provided. Both 'tools' and "</span>
                    <span class="s2">"'tool_choice' parameters will be overridden and "</span>
                    <span class="s2">"ignored. The model will only perform structured output "</span>
                    <span class="s2">"generation without calling any other tools."</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">format_tool</span> <span class="o">=</span> <span class="n">_create_tool_from_base_model</span><span class="p">(</span><span class="n">structured_model</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"tools"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_tools_json_schemas</span><span class="p">(</span>
                <span class="p">[</span><span class="n">format_tool</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"tool_choice"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_tool_choice</span><span class="p">(</span>
                <span class="n">format_tool</span><span class="p">[</span><span class="s2">"function"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"qvq"</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">"-vl"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">dashscope</span><span class="o">.</span><span class="n">MultiModalConversation</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                <span class="n">api_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">dashscope</span><span class="o">.</span><span class="n">aigc</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">AioGeneration</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                <span class="n">api_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_dashscope_stream_response</span><span class="p">(</span>
                <span class="n">start_datetime</span><span class="p">,</span>
                <span class="n">response</span><span class="p">,</span>
                <span class="n">structured_model</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">parsed_response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_dashscope_generation_response</span><span class="p">(</span>
            <span class="n">start_datetime</span><span class="p">,</span>
            <span class="n">response</span><span class="p">,</span>
            <span class="n">structured_model</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">parsed_response</span></div>


    <span class="c1"># pylint: disable=too-many-branches</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_parse_dashscope_stream_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_datetime</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">GenerationResponse</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
            <span class="n">Generator</span><span class="p">[</span><span class="n">MultiModalConversationResponse</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="p">],</span>
        <span class="n">structured_model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">ChatResponse</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Given a DashScope streaming response generator, extract the content</span>
<span class="sd">            blocks and usages from it and yield ChatResponse objects.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_datetime (`datetime`):</span>
<span class="sd">                The start datetime of the response generation.</span>
<span class="sd">            response (</span>
<span class="sd">                `Union[AsyncGenerator[GenerationResponse, None], Generator[ \</span>
<span class="sd">                MultiModalConversationResponse, None, None]]`</span>
<span class="sd">            ):</span>
<span class="sd">                DashScope streaming response generator (GenerationResponse or</span>
<span class="sd">                MultiModalConversationResponse) to parse.</span>
<span class="sd">            structured_model (`Type[BaseModel] | None`, default `None`):</span>
<span class="sd">                A Pydantic BaseModel class that defines the expected structure</span>
<span class="sd">                for the model's output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            AsyncGenerator[ChatResponse, Any]:</span>
<span class="sd">                An async generator that yields ChatResponse objects containing</span>
<span class="sd">                the content blocks and usage information for each chunk in the</span>
<span class="sd">                streaming response.</span>

<span class="sd">        .. note::</span>
<span class="sd">            If `structured_model` is not `None`, the expected structured output</span>
<span class="sd">            will be stored in the metadata of the `ChatResponse`.</span>
<span class="sd">        """</span>
        <span class="n">acc_content</span><span class="p">,</span> <span class="n">acc_thinking_content</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span> <span class="s2">""</span>
        <span class="n">acc_tool_calls</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">giter</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">chunk</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"Failed to get response from _ API: </span><span class="si">{</span><span class="n">chunk</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">message</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>

            <span class="c1"># Update reasoning content</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"reasoning_content"</span><span class="p">),</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">acc_thinking_content</span> <span class="o">+=</span> <span class="n">message</span><span class="p">[</span><span class="s2">"reasoning_content"</span><span class="p">]</span>

            <span class="c1"># Update text content</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">acc_content</span> <span class="o">+=</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"text"</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                        <span class="n">acc_content</span> <span class="o">+=</span> <span class="n">item</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span>

            <span class="c1"># Update tool calls</span>
            <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"tool_calls"</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"index"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">"id"</span> <span class="ow">in</span> <span class="n">tool_call</span> <span class="ow">and</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">acc_tool_calls</span><span class="p">[</span>
                    <span class="n">index</span>
                <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"id"</span><span class="p">):</span>
                    <span class="n">acc_tool_calls</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">acc_tool_calls</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span> <span class="o">+</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="s2">"function"</span> <span class="ow">in</span> <span class="n">tool_call</span><span class="p">:</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">"function"</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s2">"name"</span> <span class="ow">in</span> <span class="n">func</span><span class="p">:</span>
                        <span class="n">acc_tool_calls</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">acc_tool_calls</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
                            <span class="o">+</span> <span class="n">func</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="s2">"arguments"</span> <span class="ow">in</span> <span class="n">func</span><span class="p">:</span>
                        <span class="n">acc_tool_calls</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">"arguments"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">acc_tool_calls</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"arguments"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
                            <span class="o">+</span> <span class="n">func</span><span class="p">[</span><span class="s2">"arguments"</span><span class="p">]</span>
                        <span class="p">)</span>

            <span class="c1"># to content blocks</span>
            <span class="n">content_blocks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TextBlock</span> <span class="o">|</span> <span class="n">ToolUseBlock</span> <span class="o">|</span> <span class="n">ThinkingBlock</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">acc_thinking_content</span><span class="p">:</span>
                <span class="n">content_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ThinkingBlock</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">"thinking"</span><span class="p">,</span>
                        <span class="n">thinking</span><span class="o">=</span><span class="n">acc_thinking_content</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">acc_content</span><span class="p">:</span>
                <span class="n">content_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TextBlock</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">"text"</span><span class="p">,</span>
                        <span class="n">text</span><span class="o">=</span><span class="n">acc_content</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">acc_tool_calls</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">repaired_input</span> <span class="o">=</span> <span class="n">_json_loads_with_repair</span><span class="p">(</span>
                    <span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"arguments"</span><span class="p">,</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">"</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">"</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repaired_input</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">repaired_input</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="n">content_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ToolUseBlock</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">"tool_use"</span><span class="p">,</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span>
                        <span class="nb">input</span><span class="o">=</span><span class="n">repaired_input</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">structured_model</span><span class="p">:</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">repaired_input</span>

            <span class="n">usage</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">chunk</span><span class="o">.</span><span class="n">usage</span><span class="p">:</span>
                <span class="n">usage</span> <span class="o">=</span> <span class="n">ChatUsage</span><span class="p">(</span>
                    <span class="n">input_tokens</span><span class="o">=</span><span class="n">chunk</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">input_tokens</span><span class="p">,</span>
                    <span class="n">output_tokens</span><span class="o">=</span><span class="n">chunk</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">output_tokens</span><span class="p">,</span>
                    <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_datetime</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span>
                <span class="p">)</span>

            <span class="n">parsed_chunk</span> <span class="o">=</span> <span class="n">ChatResponse</span><span class="p">(</span>
                <span class="n">content</span><span class="o">=</span><span class="n">content_blocks</span><span class="p">,</span>
                <span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">yield</span> <span class="n">parsed_chunk</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_parse_dashscope_generation_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_datetime</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">GenerationResponse</span><span class="p">,</span>
            <span class="n">MultiModalConversationResponse</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">structured_model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Given a DashScope GenerationResponse object, extract the content</span>
<span class="sd">        blocks and usages from it.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_datetime (`datetime`):</span>
<span class="sd">                The start datetime of the response generation.</span>
<span class="sd">            response (</span>
<span class="sd">                `Union[GenerationResponse, MultiModalConversationResponse]`</span>
<span class="sd">            ):</span>
<span class="sd">                Dashscope GenerationResponse | MultiModalConversationResponse</span>
<span class="sd">                object to parse.</span>
<span class="sd">            structured_model (`Type[BaseModel] | None`, default `None`):</span>
<span class="sd">                A Pydantic BaseModel class that defines the expected structure</span>
<span class="sd">                for the model's output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ChatResponse (`ChatResponse`):</span>
<span class="sd">                A ChatResponse object containing the content blocks and usage.</span>

<span class="sd">        .. note::</span>
<span class="sd">            If `structured_model` is not `None`, the expected structured output</span>
<span class="sd">            will be stored in the metadata of the `ChatResponse`.</span>
<span class="sd">        """</span>
        <span class="c1"># Collect the content blocks from the response.</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="n">content_blocks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TextBlock</span> <span class="o">|</span> <span class="n">ToolUseBlock</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"content"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"content"</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="s2">""</span><span class="p">,</span>
            <span class="p">[],</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"text"</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                        <span class="n">content_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">TextBlock</span><span class="p">(</span>
                                <span class="nb">type</span><span class="o">=</span><span class="s2">"text"</span><span class="p">,</span>
                                <span class="n">text</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">"text"</span><span class="p">],</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">content_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TextBlock</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">"text"</span><span class="p">,</span>
                        <span class="n">text</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"tool_calls"</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">message</span><span class="p">[</span><span class="s2">"tool_calls"</span><span class="p">]:</span>
                <span class="n">input_</span> <span class="o">=</span> <span class="n">_json_loads_with_repair</span><span class="p">(</span>
                    <span class="n">tool_call</span><span class="p">[</span><span class="s2">"function"</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">"arguments"</span><span class="p">,</span>
                        <span class="s2">"</span><span class="si">{}</span><span class="s2">"</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="ow">or</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">"</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">content_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ToolUseBlock</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">"tool_use"</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">tool_call</span><span class="p">[</span><span class="s2">"function"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">],</span>
                        <span class="nb">input</span><span class="o">=</span><span class="n">input_</span><span class="p">,</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">tool_call</span><span class="p">[</span><span class="s2">"id"</span><span class="p">],</span>
                    <span class="p">),</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">structured_model</span><span class="p">:</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">input_</span>

        <span class="c1"># Usage information</span>
        <span class="n">usage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="p">:</span>
            <span class="n">usage</span> <span class="o">=</span> <span class="n">ChatUsage</span><span class="p">(</span>
                <span class="n">input_tokens</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">input_tokens</span><span class="p">,</span>
                <span class="n">output_tokens</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">output_tokens</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_datetime</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span>
            <span class="p">)</span>

        <span class="n">parsed_response</span> <span class="o">=</span> <span class="n">ChatResponse</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">content_blocks</span><span class="p">,</span>
            <span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">parsed_response</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_tools_json_schemas</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">schemas</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Format the tools JSON schema into required format for DashScope API.</span>

<span class="sd">        Args:</span>
<span class="sd">            schemas (`dict[str, dict[str, Any]]`):</span>
<span class="sd">                The tools JSON schemas.</span>
<span class="sd">        """</span>
        <span class="c1"># Check schemas format</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">schemas</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="ow">or</span> <span class="s2">"type"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span>
                <span class="ow">or</span> <span class="n">value</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">"function"</span>
                <span class="ow">or</span> <span class="s2">"function"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"Each schema must be a dict with 'type' as 'function' "</span>
                    <span class="sa">f</span><span class="s2">"and 'function' key, got </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">schemas</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_tool_choice</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"none"</span><span class="p">,</span> <span class="s2">"any"</span><span class="p">,</span> <span class="s2">"required"</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Format tool_choice parameter for API compatibility.</span>

<span class="sd">        Args:</span>
<span class="sd">            tool_choice (`Literal["auto", "none",  "any", "required"] | str \</span>
<span class="sd">            | None`, default  `None`):</span>
<span class="sd">                Controls which (if any) tool is called by the model.</span>
<span class="sd">                 Can be "auto", "none", or specific tool name.</span>
<span class="sd">                 For more details, please refer to</span>
<span class="sd">                 https://help.aliyun.com/zh/model-studio/qwen-function-calling</span>
<span class="sd">        Returns:</span>
<span class="sd">            `dict | None`:</span>
<span class="sd">                The formatted tool choice configuration dict, or None if</span>
<span class="sd">                    tool_choice is None.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">tool_choice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">tool_choice</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"none"</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">tool_choice</span>
        <span class="k">if</span> <span class="n">tool_choice</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"any"</span><span class="p">,</span> <span class="s2">"required"</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">"tool_choice '</span><span class="si">%s</span><span class="s2">' is not supported by DashScope API. "</span>
                <span class="s2">"Supported options are 'auto', 'none', or specific function "</span>
                <span class="s2">"name. Automatically using 'auto' instead."</span><span class="p">,</span>
                <span class="n">tool_choice</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="s2">"auto"</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"function"</span><span class="p">,</span> <span class="s2">"function"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="n">tool_choice</span><span class="p">}}</span></div>

</pre></div>
        