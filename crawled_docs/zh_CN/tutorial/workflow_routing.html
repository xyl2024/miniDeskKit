<!-- Title: Routing - AgentScope -->
<!-- URL: https://doc.agentscope.io/zh_CN/tutorial/workflow_routing.html -->

          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">备注</p>
<p><a class="reference internal" href="#sphx-glr-download-tutorial-workflow-routing-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="routing">
<span id="sphx-glr-tutorial-workflow-routing-py"></span><span id="id1"></span><h1>Routing<a class="headerlink" href="#routing" title="Link to this heading">¶</a></h1>
<p>在 AgentScope 中有两种实现 Routing 的方法，都简单易实现：</p>
<ul class="simple">
<li><p>使用结构化输出的显式 routing</p></li>
<li><p>使用工具调用的隐式 routing</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>考虑到智能体 routing 没有统一的标准/定义，我们遵循 <a class="reference external" href="https://www.anthropic.com/engineering/building-effective-agents">Building effective agents</a> 中的设置</p>
</div>
<section id="id2">
<h2>显式 Routing<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<p>在显式 routing 中，我们可以直接使用智能体的结构化输出来确定将消息路由到哪个智能体。</p>
<p>初始化 routing 智能体</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReActAgent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.formatter</span><span class="w"> </span><span class="kn">import</span> <span class="n">DashScopeChatFormatter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryMemory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.message</span><span class="w"> </span><span class="kn">import</span> <span class="n">Msg</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">DashScopeChatModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.tool</span><span class="w"> </span><span class="kn">import</span> <span class="n">Toolkit</span><span class="p">,</span> <span class="n">ToolResponse</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">ReActAgent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"Router"</span><span class="p">,</span>
    <span class="n">sys_prompt</span><span class="o">=</span><span class="s2">"你是一个路由智能体。你的目标是将用户查询路由到正确的后续任务，注意你不需要回答用户的问题。"</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">DashScopeChatModel</span><span class="p">(</span>
        <span class="n">model_name</span><span class="o">=</span><span class="s2">"qwen-max"</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"DASHSCOPE_API_KEY"</span><span class="p">],</span>
        <span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">formatter</span><span class="o">=</span><span class="n">DashScopeChatFormatter</span><span class="p">(),</span>
<span class="p">)</span>


<span class="c1"># 使用结构化输出指定路由任务</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RoutingChoice</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">your_choice</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
        <span class="s2">"Content Generation"</span><span class="p">,</span>
        <span class="s2">"Programming"</span><span class="p">,</span>
        <span class="s2">"Information Retrieval"</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"选择正确的后续任务，如果任务太简单或没有合适的任务，则选择 ``None``"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"任务描述"</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">example_router_explicit</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""使用结构化输出进行显式路由的示例。"""</span>
    <span class="n">msg_user</span> <span class="o">=</span> <span class="n">Msg</span><span class="p">(</span>
        <span class="s2">"user"</span><span class="p">,</span>
        <span class="s2">"帮我写一首诗"</span><span class="p">,</span>
        <span class="s2">"user"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 路由查询</span>
    <span class="n">msg_res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">router</span><span class="p">(</span>
        <span class="n">msg_user</span><span class="p">,</span>
        <span class="n">structured_model</span><span class="o">=</span><span class="n">RoutingChoice</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 结构化输出存储在 metadata 字段中</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"结构化输出："</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg_res</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">example_router_explicit</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Router: 好的，我来为你创作一首诗。
结构化输出：
{
    "your_choice": "Content Generation",
    "task_description": "为用户写一首诗"
}
</pre></div>
</div>
</section>
<section id="id3">
<h2>隐式 Routing<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p>另一种方法是将下游智能体包装成工具函数，这样路由智能体就可以根据用户查询决定调用哪个工具。</p>
<p>我们首先定义几个工具函数：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_python</span><span class="p">(</span><span class="n">demand</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""根据需求生成 Python 代码。</span>

<span class="sd">    Args:</span>
<span class="sd">        demand (``str``):</span>
<span class="sd">            对 Python 代码的需求。</span>
<span class="sd">    """</span>
    <span class="c1"># 示例需求智能体</span>
    <span class="n">python_agent</span> <span class="o">=</span> <span class="n">ReActAgent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">"PythonAgent"</span><span class="p">,</span>
        <span class="n">sys_prompt</span><span class="o">=</span><span class="s2">"你是一个 Python 专家，你的目标是根据需求生成 Python 代码。"</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">DashScopeChatModel</span><span class="p">(</span>
            <span class="n">model_name</span><span class="o">=</span><span class="s2">"qwen-max"</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"DASHSCOPE_API_KEY"</span><span class="p">],</span>
            <span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">memory</span><span class="o">=</span><span class="n">InMemoryMemory</span><span class="p">(),</span>
        <span class="n">formatter</span><span class="o">=</span><span class="n">DashScopeChatFormatter</span><span class="p">(),</span>
        <span class="n">toolkit</span><span class="o">=</span><span class="n">Toolkit</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">msg_res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">python_agent</span><span class="p">(</span><span class="n">Msg</span><span class="p">(</span><span class="s2">"user"</span><span class="p">,</span> <span class="n">demand</span><span class="p">,</span> <span class="s2">"user"</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ToolResponse</span><span class="p">(</span>
        <span class="n">content</span><span class="o">=</span><span class="n">msg_res</span><span class="o">.</span><span class="n">get_content_blocks</span><span class="p">(</span><span class="s2">"text"</span><span class="p">),</span>
    <span class="p">)</span>


<span class="c1"># 为演示目的模拟一些其他工具函数</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_poem</span><span class="p">(</span><span class="n">demand</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""根据需求生成诗歌。</span>

<span class="sd">    Args:</span>
<span class="sd">        demand (``str``):</span>
<span class="sd">            对诗歌的需求。</span>
<span class="sd">    """</span>
    <span class="k">pass</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">web_search</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""在网络上搜索查询。</span>

<span class="sd">    Args:</span>
<span class="sd">        query (``str``):</span>
<span class="sd">            要搜索的查询。</span>
<span class="sd">    """</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>之后，我们定义一个路由智能体并为其配备上述工具函数。</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">toolkit</span> <span class="o">=</span> <span class="n">Toolkit</span><span class="p">()</span>
<span class="n">toolkit</span><span class="o">.</span><span class="n">register_tool_function</span><span class="p">(</span><span class="n">generate_python</span><span class="p">)</span>
<span class="n">toolkit</span><span class="o">.</span><span class="n">register_tool_function</span><span class="p">(</span><span class="n">generate_poem</span><span class="p">)</span>
<span class="n">toolkit</span><span class="o">.</span><span class="n">register_tool_function</span><span class="p">(</span><span class="n">web_search</span><span class="p">)</span>

<span class="c1"># 使用工具模块初始化路由智能体</span>
<span class="n">router_implicit</span> <span class="o">=</span> <span class="n">ReActAgent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"Router"</span><span class="p">,</span>
    <span class="n">sys_prompt</span><span class="o">=</span><span class="s2">"你是一个路由智能体。你的目标是将用户查询路由到正确的后续任务。"</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">DashScopeChatModel</span><span class="p">(</span>
        <span class="n">model_name</span><span class="o">=</span><span class="s2">"qwen-max"</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"DASHSCOPE_API_KEY"</span><span class="p">],</span>
        <span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">formatter</span><span class="o">=</span><span class="n">DashScopeChatFormatter</span><span class="p">(),</span>
    <span class="n">toolkit</span><span class="o">=</span><span class="n">toolkit</span><span class="p">,</span>
    <span class="n">memory</span><span class="o">=</span><span class="n">InMemoryMemory</span><span class="p">(),</span>
<span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">example_router_implicit</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""使用工具调用进行隐式路由的示例。"""</span>
    <span class="n">msg_user</span> <span class="o">=</span> <span class="n">Msg</span><span class="p">(</span>
        <span class="s2">"user"</span><span class="p">,</span>
        <span class="s2">"帮我在 Python 中生成一个快速排序函数"</span><span class="p">,</span>
        <span class="s2">"user"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 路由查询</span>
    <span class="k">await</span> <span class="n">router_implicit</span><span class="p">(</span><span class="n">msg_user</span><span class="p">)</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">example_router_implicit</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Router: {
    "type": "tool_use",
    "name": "generate_python",
    "input": {
        "demand": "生成一个快速排序函数"
    },
    "id": "call_307618542d6640db98fefb"
}
PythonAgent: 以下是一个使用 Python 编写的快速排序函数的示例。这个实现采用了一个递归的方法，选取列表中的第一个元素作为基准（pivot），然后将列表分为两部分：一部分包含所有小于基准的元素，另一部分包含所有大于或等于基准的元素。接着对这两部分再分别进行快速排序。

```python
def quicksort(arr):
    # 递归的基本情况：如果数组长度为0或1，则不需要排序
    if len(arr) &lt;= 1:
        return arr
    else:
        # 选择基准值
        pivot = arr[0]

        # 所有小于基准的元素组成的子数组
        less = [i for i in arr[1:] if i &lt; pivot]

        # 所有大于或等于基准的元素组成的子数组
        greater_or_equal = [i for i in arr[1:] if i &gt;= pivot]

        # 递归地对子数组进行快速排序，并连接结果
        return quicksort(less) + [pivot] + quicksort(greater_or_equal)

# 示例
example_list = [3, 6, 8, 10, 1, 2, 1]
sorted_list = quicksort(example_list)
print('Sorted list:', sorted_list)
```

您可以直接运行这段代码来测试快速排序功能。如果您需要一个不同的版本，比如使用随机选择的基准或者使用另一种方式来划分数组，请告诉我！
system: {
    "type": "tool_result",
    "id": "call_307618542d6640db98fefb",
    "name": "generate_python",
    "output": [
        {
            "type": "text",
            "text": "以下是一个使用 Python 编写的快速排序函数的示例。这个实现采用了一个递归的方法，选取列表中的第一个元素作为基准（pivot），然后将列表分为两部分：一部分包含所有小于基准的元素，另一部分包含所有大于或等于基准的元素。接着对这两部分再分别进行快速排序。\n\n```python\ndef quicksort(arr):\n    # 递归的基本情况：如果数组长度为0或1，则不需要排序\n    if len(arr) &lt;= 1:\n        return arr\n    else:\n        # 选择基准值\n        pivot = arr[0]\n        \n        # 所有小于基准的元素组成的子数组\n        less = [i for i in arr[1:] if i &lt; pivot]\n        \n        # 所有大于或等于基准的元素组成的子数组\n        greater_or_equal = [i for i in arr[1:] if i &gt;= pivot]\n        \n        # 递归地对子数组进行快速排序，并连接结果\n        return quicksort(less) + [pivot] + quicksort(greater_or_equal)\n\n# 示例\nexample_list = [3, 6, 8, 10, 1, 2, 1]\nsorted_list = quicksort(example_list)\nprint('Sorted list:', sorted_list)\n```\n\n您可以直接运行这段代码来测试快速排序功能。如果您需要一个不同的版本，比如使用随机选择的基准或者使用另一种方式来划分数组，请告诉我！"
        }
    ]
}
Router: 以下是一个使用 Python 编写的快速排序函数的示例。这个实现采用了一个递归的方法，选取列表中的第一个元素作为基准（pivot），然后将列表分为两部分：一部分包含所有小于基准的元素，另一部分包含所有大于或等于基准的元素。接着对这两部分再分别进行快速排序。

```python
def quicksort(arr):
    # 递归的基本情况：如果数组长度为0或1，则不需要排序
    if len(arr) &lt;= 1:
        return arr
    else:
        # 选择基准值
        pivot = arr[0]

        # 所有小于基准的元素组成的子数组
        less = [i for i in arr[1:] if i &lt; pivot]

        # 所有大于或等于基准的元素组成的子数组
        greater_or_equal = [i for i in arr[1:] if i &gt;= pivot]

        # 递归地对子数组进行快速排序，并连接结果
        return quicksort(less) + [pivot] + quicksort(greater_or_equal)

# 示例
example_list = [3, 6, 8, 10, 1, 2, 1]
sorted_list = quicksort(example_list)
print('Sorted list:', sorted_list)
```

您可以直接运行这段代码来测试快速排序功能。如果您需要一个不同的版本，比如使用随机选择的基准或者使用另一种方式来划分数组，请告诉我！
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 28.484 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-tutorial-workflow-routing-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/3266c75280f96697c4cc46d7d55a3ac8/workflow_routing.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">workflow_routing.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/c182014741a60494dac66ebedc042958/workflow_routing.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">workflow_routing.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../_downloads/80909c3056a5a38e3a0dc9bad6dd48df/workflow_routing.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">workflow_routing.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>

        