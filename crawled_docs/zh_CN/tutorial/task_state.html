<!-- Title: 状态/会话管理 - AgentScope -->
<!-- URL: https://doc.agentscope.io/zh_CN/tutorial/task_state.html -->

          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">备注</p>
<p><a class="reference internal" href="#sphx-glr-download-tutorial-task-state-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="state">
<span id="sphx-glr-tutorial-task-state-py"></span><span id="id1"></span><h1>状态/会话管理<a class="headerlink" href="#state" title="Link to this heading">¶</a></h1>
<p>在 AgentScope 中，<strong>"状态"</strong> 是指智能体在运行中某一时刻的数据快照，包括其当前的系统提示、记忆、上下文、装备的工具以及其他 <strong>随时间变化</strong> 的信息。</p>
<p>为了管理应用程序的状态，AgentScope 设计实现了 <strong>自动状态注册</strong> 和 <strong>会话级状态管理</strong>，具有以下特性：</p>
<ul class="simple">
<li><p>支持所有继承自 <code class="docutils literal notranslate"><span class="pre">StateModule</span></code> 的变量的 <strong>自动状态注册</strong></p></li>
<li><p>支持使用自定义序列化/反序列化方法的 <strong>手动状态注册</strong></p></li>
<li><p>支持 <strong>会话/应用程序级别管理</strong></p></li>
</ul>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReActAgent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.formatter</span><span class="w"> </span><span class="kn">import</span> <span class="n">DashScopeChatFormatter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryMemory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.message</span><span class="w"> </span><span class="kn">import</span> <span class="n">Msg</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">DashScopeChatModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateModule</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.session</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONSession</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.tool</span><span class="w"> </span><span class="kn">import</span> <span class="n">Toolkit</span>
</pre></div>
</div>
<section id="id2">
<h2>状态模块<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">StateModule</span></code> 类是 AgentScope 中状态管理的基础，提供三个基本函数：</p>
<div class="table-wrapper docutils container" id="id6">
<table class="docutils align-default" id="id6">
<caption><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">StateModule</span></code> 的方法</span><a class="headerlink" href="#id6" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>方法</p></th>
<th class="head"><p>参数</p></th>
<th class="head"><p>描述</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">register_state</span></code></p></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">attr_name</span></code>,</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">custom_to_json</span></code> （可选）,</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">custom_from_json</span></code> （可选）</div>
</div>
</td>
<td><p>将属性注册为其状态，带有可选的序列化/反序列化函数。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">state_dict</span></code></p></td>
<td></td>
<td><p>获取当前对象的状态字典</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">load_state_dict</span></code></p></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">state_dict</span></code>,</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">strict</span></code> （可选）</div>
</div>
</td>
<td><p>将状态字典加载到当前对象</p></td>
</tr>
</tbody>
</table>
</div>
<p>在 <code class="docutils literal notranslate"><span class="pre">StateModule</span></code> 的对象中，以下所有属性都将被视为其状态的一部分：</p>
<ul class="simple">
<li><p>继承自 <code class="docutils literal notranslate"><span class="pre">StateModule</span></code> 的 <strong>属性</strong></p></li>
<li><p>通过 <code class="docutils literal notranslate"><span class="pre">register_state</span></code> 方法注册的 <strong>属性</strong></p></li>
</ul>
<p>注意 <code class="docutils literal notranslate"><span class="pre">StateModule</span></code> 支持 <strong>嵌套</strong> 序列化和反序列化，例如下面的示例中，<code class="docutils literal notranslate"><span class="pre">ClassB</span></code> 中包含一个 <code class="docutils literal notranslate"><span class="pre">ClassA</span></code> 的实例：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ClassA</span><span class="p">(</span><span class="n">StateModule</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">123</span>
        <span class="c1"># 将 cnt 属性注册为状态</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_state</span><span class="p">(</span><span class="s2">"cnt"</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ClassB</span><span class="p">(</span><span class="n">StateModule</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># 属性 "a" 继承自 StateModule，将自动视为状态的一部分</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">ClassA</span><span class="p">()</span>

        <span class="c1"># 手动将属性 "c" 注册为状态</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="s2">"Hello, world!"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_state</span><span class="p">(</span><span class="s2">"c"</span><span class="p">)</span>


<span class="n">obj_b</span> <span class="o">=</span> <span class="n">ClassB</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"obj_b.a 的状态："</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">obj_b</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">obj_b 的状态："</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj_b</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>obj_b.a 的状态：
{'cnt': 123}

obj_b 的状态：
{
    "a": {
        "cnt": 123
    },
    "c": "Hello, world!"
}
</pre></div>
</div>
<p>我们可以观察到 <code class="docutils literal notranslate"><span class="pre">obj_b</span></code> 的状态自动包含了其属性 <code class="docutils literal notranslate"><span class="pre">a</span></code> 的状态。</p>
<p>在 AgentScope 中，<code class="docutils literal notranslate"><span class="pre">AgentBase</span></code>、<code class="docutils literal notranslate"><span class="pre">MemoryBase</span></code>、<code class="docutils literal notranslate"><span class="pre">LongTermMemoryBase</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Toolkit</span></code> 类都继承自 <code class="docutils literal notranslate"><span class="pre">StateModule</span></code>，因此支持自动和嵌套状态管理。</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 创建一个智能体</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">ReActAgent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"Friday"</span><span class="p">,</span>
    <span class="n">sys_prompt</span><span class="o">=</span><span class="s2">"你是一个名为 Friday 的助手。"</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">DashScopeChatModel</span><span class="p">(</span>
        <span class="n">model_name</span><span class="o">=</span><span class="s2">"qwen-max"</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"DASHSCOPE_API_KEY"</span><span class="p">],</span>
    <span class="p">),</span>
    <span class="n">formatter</span><span class="o">=</span><span class="n">DashScopeChatFormatter</span><span class="p">(),</span>
    <span class="n">memory</span><span class="o">=</span><span class="n">InMemoryMemory</span><span class="p">(),</span>
    <span class="n">toolkit</span><span class="o">=</span><span class="n">Toolkit</span><span class="p">(),</span>
<span class="p">)</span>

<span class="n">initial_state</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"智能体的初始状态："</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">initial_state</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>智能体的初始状态：
{
    "memory": {
        "content": []
    },
    "toolkit": {
        "active_groups": []
    },
    "_reasoning_hint_msgs": {
        "content": []
    },
    "name": "Friday",
    "_sys_prompt": "你是一个名为 Friday 的助手。"
}
</pre></div>
</div>
<p>然后我们通过生成回复消息来改变其状态：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">example_agent_state</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""智能体状态管理示例。"""</span>
    <span class="k">await</span> <span class="n">agent</span><span class="p">(</span><span class="n">Msg</span><span class="p">(</span><span class="s2">"user"</span><span class="p">,</span> <span class="s2">"你好，智能体！"</span><span class="p">,</span> <span class="s2">"user"</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"生成回复后智能体的状态："</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">example_agent_state</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Friday: 你好！有什么我能帮助你的吗？
生成回复后智能体的状态：
{
    "memory": {
        "content": [
            {
                "id": "4GpfVrY38fVSwnLR8xBAzo",
                "name": "user",
                "role": "user",
                "content": "你好，智能体！",
                "metadata": null,
                "timestamp": "2025-10-03 14:52:31.091"
            },
            {
                "id": "AkaYpQvmMnLpt4JpTjBxrZ",
                "name": "Friday",
                "role": "assistant",
                "content": [
                    {
                        "id": "LktKLnZy7SMxAsa7dCQKMf",
                        "type": "tool_use",
                        "name": "generate_response",
                        "input": {
                            "response": "你好！有什么我能帮助你的吗？"
                        }
                    }
                ],
                "metadata": null,
                "timestamp": "2025-10-03 14:52:31.092"
            },
            {
                "id": "dx8744WMqTWi55DzKiF6AW",
                "name": "system",
                "role": "system",
                "content": [
                    {
                        "type": "tool_result",
                        "id": "LktKLnZy7SMxAsa7dCQKMf",
                        "name": "generate_response",
                        "output": [
                            {
                                "type": "text",
                                "text": "Successfully generated response."
                            }
                        ]
                    }
                ],
                "metadata": null,
                "timestamp": "2025-10-03 14:52:32.350"
            },
            {
                "id": "FLGgXro9hbG6gC3XnrmSoB",
                "name": "Friday",
                "role": "assistant",
                "content": "你好！有什么我能帮助你的吗？",
                "metadata": null,
                "timestamp": "2025-10-03 14:52:32.350"
            }
        ]
    },
    "toolkit": {
        "active_groups": []
    },
    "_reasoning_hint_msgs": {
        "content": []
    },
    "name": "Friday",
    "_sys_prompt": "你是一个名为 Friday 的助手。"
}
</pre></div>
</div>
<p>现在我们将智能体的状态恢复到初始状态：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">agent</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">initial_state</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"加载初始状态后："</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>加载初始状态后：
{
    "memory": {
        "content": []
    },
    "toolkit": {
        "active_groups": []
    },
    "_reasoning_hint_msgs": {
        "content": []
    },
    "name": "Friday",
    "_sys_prompt": "你是一个名为 Friday 的助手。"
}
</pre></div>
</div>
</section>
<section id="id3">
<h2>会话管理<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p>会话（Session）是应用程序中状态的集合，例如多个智能体。</p>
<p>AgentScope 提供了 <code class="docutils literal notranslate"><span class="pre">SessionBase</span></code> 类，包含两个用于会话管理的抽象方法：<code class="docutils literal notranslate"><span class="pre">save_session_state</span></code> 和 <code class="docutils literal notranslate"><span class="pre">load_session_state</span></code>。
开发者可以继承该类来实现自己的状态保存方案，例如对接到自己的数据库或文件系统。</p>
<p>在 AgentScope 中，我们提供了基于 JSON 和文件系统的的会话类 <code class="docutils literal notranslate"><span class="pre">JSONSession</span></code>，
它会将状态保存到会化 ID 命名的 JSON 文件中，也可以从中加载状态。</p>
<section id="id4">
<h3>保存会话状态<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h3>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 通过生成回复消息改变智能体状态</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">example_agent_state</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">智能体的状态："</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Friday: 你好！有什么我能帮助你的吗？
生成回复后智能体的状态：
{
    "memory": {
        "content": [
            {
                "id": "Xc7Jck2Kw2KGEtoTdqFcCm",
                "name": "user",
                "role": "user",
                "content": "你好，智能体！",
                "metadata": null,
                "timestamp": "2025-10-03 14:52:32.353"
            },
            {
                "id": "ENRawLcYS2zY9C38j5S9Y4",
                "name": "Friday",
                "role": "assistant",
                "content": [
                    {
                        "id": "bDzgKLZ7AcpY9CAipzYMMd",
                        "type": "tool_use",
                        "name": "generate_response",
                        "input": {
                            "response": "你好！有什么我能帮助你的吗？"
                        }
                    }
                ],
                "metadata": null,
                "timestamp": "2025-10-03 14:52:32.353"
            },
            {
                "id": "BixQDPVR6UShNk3QesYDNj",
                "name": "system",
                "role": "system",
                "content": [
                    {
                        "type": "tool_result",
                        "id": "bDzgKLZ7AcpY9CAipzYMMd",
                        "name": "generate_response",
                        "output": [
                            {
                                "type": "text",
                                "text": "Successfully generated response."
                            }
                        ]
                    }
                ],
                "metadata": null,
                "timestamp": "2025-10-03 14:52:33.526"
            },
            {
                "id": "iG73ZmhgacdSPq3HE6xLez",
                "name": "Friday",
                "role": "assistant",
                "content": "你好！有什么我能帮助你的吗？",
                "metadata": null,
                "timestamp": "2025-10-03 14:52:33.526"
            }
        ]
    },
    "toolkit": {
        "active_groups": []
    },
    "_reasoning_hint_msgs": {
        "content": []
    },
    "name": "Friday",
    "_sys_prompt": "你是一个名为 Friday 的助手。"
}

智能体的状态：
{
    "memory": {
        "content": [
            {
                "id": "Xc7Jck2Kw2KGEtoTdqFcCm",
                "name": "user",
                "role": "user",
                "content": "你好，智能体！",
                "metadata": null,
                "timestamp": "2025-10-03 14:52:32.353"
            },
            {
                "id": "ENRawLcYS2zY9C38j5S9Y4",
                "name": "Friday",
                "role": "assistant",
                "content": [
                    {
                        "id": "bDzgKLZ7AcpY9CAipzYMMd",
                        "type": "tool_use",
                        "name": "generate_response",
                        "input": {
                            "response": "你好！有什么我能帮助你的吗？"
                        }
                    }
                ],
                "metadata": null,
                "timestamp": "2025-10-03 14:52:32.353"
            },
            {
                "id": "BixQDPVR6UShNk3QesYDNj",
                "name": "system",
                "role": "system",
                "content": [
                    {
                        "type": "tool_result",
                        "id": "bDzgKLZ7AcpY9CAipzYMMd",
                        "name": "generate_response",
                        "output": [
                            {
                                "type": "text",
                                "text": "Successfully generated response."
                            }
                        ]
                    }
                ],
                "metadata": null,
                "timestamp": "2025-10-03 14:52:33.526"
            },
            {
                "id": "iG73ZmhgacdSPq3HE6xLez",
                "name": "Friday",
                "role": "assistant",
                "content": "你好！有什么我能帮助你的吗？",
                "metadata": null,
                "timestamp": "2025-10-03 14:52:33.526"
            }
        ]
    },
    "toolkit": {
        "active_groups": []
    },
    "_reasoning_hint_msgs": {
        "content": []
    },
    "name": "Friday",
    "_sys_prompt": "你是一个名为 Friday 的助手。"
}
</pre></div>
</div>
<p>然后我们将其保存到会话文件中：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">session</span> <span class="o">=</span> <span class="n">JSONSession</span><span class="p">(</span>
    <span class="n">save_dir</span><span class="o">=</span><span class="s2">"./"</span><span class="p">,</span>  <span class="c1"># 保存所有session文件的目录</span>
<span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">example_session</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""会话管理示例。"""</span>

    <span class="c1"># 可以保存多个状态，只需要输入的对象为 `StateModule` 的子类。</span>
    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">save_session_state</span><span class="p">(</span>
        <span class="n">session_id</span><span class="o">=</span><span class="s2">"user_bob"</span><span class="p">,</span>
        <span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"保存的状态："</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"./user_bob.json"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">example_session</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>保存的状态：
{
    "agent": {
        "memory": {
            "content": [
                {
                    "id": "Xc7Jck2Kw2KGEtoTdqFcCm",
                    "name": "user",
                    "role": "user",
                    "content": "你好，智能体！",
                    "metadata": null,
                    "timestamp": "2025-10-03 14:52:32.353"
                },
                {
                    "id": "ENRawLcYS2zY9C38j5S9Y4",
                    "name": "Friday",
                    "role": "assistant",
                    "content": [
                        {
                            "id": "bDzgKLZ7AcpY9CAipzYMMd",
                            "type": "tool_use",
                            "name": "generate_response",
                            "input": {
                                "response": "你好！有什么我能帮助你的吗？"
                            }
                        }
                    ],
                    "metadata": null,
                    "timestamp": "2025-10-03 14:52:32.353"
                },
                {
                    "id": "BixQDPVR6UShNk3QesYDNj",
                    "name": "system",
                    "role": "system",
                    "content": [
                        {
                            "type": "tool_result",
                            "id": "bDzgKLZ7AcpY9CAipzYMMd",
                            "name": "generate_response",
                            "output": [
                                {
                                    "type": "text",
                                    "text": "Successfully generated response."
                                }
                            ]
                        }
                    ],
                    "metadata": null,
                    "timestamp": "2025-10-03 14:52:33.526"
                },
                {
                    "id": "iG73ZmhgacdSPq3HE6xLez",
                    "name": "Friday",
                    "role": "assistant",
                    "content": "你好！有什么我能帮助你的吗？",
                    "metadata": null,
                    "timestamp": "2025-10-03 14:52:33.526"
                }
            ]
        },
        "toolkit": {
            "active_groups": []
        },
        "_reasoning_hint_msgs": {
            "content": []
        },
        "name": "Friday",
        "_sys_prompt": "你是一个名为 Friday 的助手。"
    }
}
</pre></div>
</div>
</section>
<section id="id5">
<h3>加载会话状态<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h3>
<p>然后我们可以从会话文件中加载状态：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">example_load_session</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""加载会话状态示例。"""</span>

    <span class="c1"># 清空智能体状态</span>
    <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"当前智能体状态："</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="c1"># 从会话文件中加载状态</span>
    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">load_session_state</span><span class="p">(</span>
        <span class="n">session_id</span><span class="o">=</span><span class="s2">"user_bob"</span><span class="p">,</span>
        <span class="c1"># 这里使用的关键词参数必须与 `save_session_state` 中的参数一致</span>
        <span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"加载会话状态后智能体的状态："</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">example_load_session</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>当前智能体状态：
{
    "memory": {
        "content": []
    },
    "toolkit": {
        "active_groups": []
    },
    "_reasoning_hint_msgs": {
        "content": []
    },
    "name": "Friday",
    "_sys_prompt": "你是一个名为 Friday 的助手。"
}
加载会话状态后智能体的状态：
{
    "memory": {
        "content": [
            {
                "id": "Xc7Jck2Kw2KGEtoTdqFcCm",
                "name": "user",
                "role": "user",
                "content": "你好，智能体！",
                "metadata": null,
                "timestamp": "2025-10-03 14:52:32.353"
            },
            {
                "id": "ENRawLcYS2zY9C38j5S9Y4",
                "name": "Friday",
                "role": "assistant",
                "content": [
                    {
                        "id": "bDzgKLZ7AcpY9CAipzYMMd",
                        "type": "tool_use",
                        "name": "generate_response",
                        "input": {
                            "response": "你好！有什么我能帮助你的吗？"
                        }
                    }
                ],
                "metadata": null,
                "timestamp": "2025-10-03 14:52:32.353"
            },
            {
                "id": "BixQDPVR6UShNk3QesYDNj",
                "name": "system",
                "role": "system",
                "content": [
                    {
                        "type": "tool_result",
                        "id": "bDzgKLZ7AcpY9CAipzYMMd",
                        "name": "generate_response",
                        "output": [
                            {
                                "type": "text",
                                "text": "Successfully generated response."
                            }
                        ]
                    }
                ],
                "metadata": null,
                "timestamp": "2025-10-03 14:52:33.526"
            },
            {
                "id": "iG73ZmhgacdSPq3HE6xLez",
                "name": "Friday",
                "role": "assistant",
                "content": "你好！有什么我能帮助你的吗？",
                "metadata": null,
                "timestamp": "2025-10-03 14:52:33.526"
            }
        ]
    },
    "toolkit": {
        "active_groups": []
    },
    "_reasoning_hint_msgs": {
        "content": []
    },
    "name": "Friday",
    "_sys_prompt": "你是一个名为 Friday 的助手。"
}
</pre></div>
</div>
<p>此时我们可以观察到智能体的状态已经恢复到之前保存的状态。</p>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 2.447 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-tutorial-task-state-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/78801218992541b6da6586f399b20cbd/task_state.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">task_state.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/30aecb5a66cf60f2a6e918a3b8190e59/task_state.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">task_state.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../_downloads/2b70015952f1e841e53a46386df8ff63/task_state.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">task_state.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>
</section>

        