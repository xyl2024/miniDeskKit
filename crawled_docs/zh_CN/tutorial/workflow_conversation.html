<!-- Title: Conversation - AgentScope -->
<!-- URL: https://doc.agentscope.io/zh_CN/tutorial/workflow_conversation.html -->

          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">备注</p>
<p><a class="reference internal" href="#sphx-glr-download-tutorial-workflow-conversation-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="conversation">
<span id="sphx-glr-tutorial-workflow-conversation-py"></span><span id="id1"></span><h1>Conversation<a class="headerlink" href="#conversation" title="Link to this heading">¶</a></h1>
<p>Conversation 是一种智能体间交换和共享信息的设计模式，常见于游戏、聊天机器人和多智能体讨论场景。</p>
<p>在 AgentScope 中，conversation 的构建在 <strong>显式的消息传递</strong> 基础上。在本章中，我们将演示如何构建：</p>
<ul class="simple">
<li><p>User-assistant 之间的对话（聊天机器人）</p></li>
<li><p>多实体对话（游戏、讨论等）</p></li>
</ul>
<p>它们的主要区别在于</p>
<ul class="simple">
<li><p><strong>提示的构建方式</strong>，以及</p></li>
<li><p>信息在智能体之间的 <strong>传播/共享</strong> 方式。</p></li>
</ul>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReActAgent</span><span class="p">,</span> <span class="n">UserAgent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryMemory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.formatter</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">DashScopeChatFormatter</span><span class="p">,</span>
    <span class="n">DashScopeMultiAgentFormatter</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">DashScopeChatModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.message</span><span class="w"> </span><span class="kn">import</span> <span class="n">Msg</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">MsgHub</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.tool</span><span class="w"> </span><span class="kn">import</span> <span class="n">Toolkit</span>
</pre></div>
</div>
<section id="user-assistant">
<h2>User-Assistant 对话<a class="headerlink" href="#user-assistant" title="Link to this heading">¶</a></h2>
<p>User-assistant 对话，也称为聊天机器人（chatbot），是最常见的智能体应用，也是当前大多数 LLM API 的设计模式。
在这种对话只有两个参与者：用户（user）和智能体（assistant）。</p>
<p>在 AgentScope 中，名称中带有 <strong>"Chat"</strong> 的格式化器专为 user-assistant 对话设计，
如 <code class="docutils literal notranslate"><span class="pre">DashScopeChatFormatter</span></code>、<code class="docutils literal notranslate"><span class="pre">AnthropicChatFormatter</span></code> 等。
它们使用消息中的 <code class="docutils literal notranslate"><span class="pre">role</span></code> 字段来区分用户和智能体，并相应地格式化消息。</p>
<p>这里我们构建智能体 <code class="docutils literal notranslate"><span class="pre">Friday</span></code> 和用户之间的简单对话。</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>AgentScope 提供了内置的 <code class="docutils literal notranslate"><span class="pre">UserAgent</span></code> 类，用于人机交互（HITL）。更多详细信息请参考 <span class="xref std std-ref">user-agent</span>。</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">friday</span> <span class="o">=</span> <span class="n">ReActAgent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"Friday"</span><span class="p">,</span>
    <span class="n">sys_prompt</span><span class="o">=</span><span class="s2">"你是一个名为 Friday 的有用助手"</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">DashScopeChatModel</span><span class="p">(</span>
        <span class="n">model_name</span><span class="o">=</span><span class="s2">"qwen-max"</span><span class="p">,</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"DASHSCOPE_API_KEY"</span><span class="p">],</span>
    <span class="p">),</span>
    <span class="n">formatter</span><span class="o">=</span><span class="n">DashScopeChatFormatter</span><span class="p">(),</span>  <span class="c1"># 用于 user-assistant 对话的格式化器</span>
    <span class="n">memory</span><span class="o">=</span><span class="n">InMemoryMemory</span><span class="p">(),</span>
    <span class="n">toolkit</span><span class="o">=</span><span class="n">Toolkit</span><span class="p">(),</span>
<span class="p">)</span>

<span class="c1"># 创建用户智能体</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">UserAgent</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"User"</span><span class="p">)</span>
</pre></div>
</div>
<p>现在，我们可以通过在这两个智能体之间交换消息来开始对话，直到用户输入"exit"结束对话。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_conversation</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""运行 Friday 和用户之间的简单对话。"""</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">friday</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_text_content</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"exit"</span><span class="p">:</span>
            <span class="k">break</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_conversation</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="id2">
<h2>多实体对话<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<p>如开头所述，我们演示如何在 <strong>提示构建</strong> 和 <strong>信息共享</strong> 方面构建多智能体对话。</p>
<section id="id3">
<h3>构建提示<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h3>
<p>在 AgentScope 中，我们为多智能体对话提供了内置格式化器，其名称中带有 <strong>"MultiAgent"</strong>，
如 <code class="docutils literal notranslate"><span class="pre">DashScopeMultiAgentFormatter</span></code>、<code class="docutils literal notranslate"><span class="pre">AnthropicMultiAgentFormatter</span></code> 等。</p>
<p>具体而言，它们使用消息中的 <code class="docutils literal notranslate"><span class="pre">name</span></code> 字段来区分不同的实体，并将对话历史格式化为单个用户消息。
以 <code class="docutils literal notranslate"><span class="pre">DashScopeMultiAgentFormatter</span></code> 为例：</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>有关格式化器的更多详细信息可以在 <a class="reference internal" href="task_prompt.html#prompt"><span class="std std-ref">提示词格式化</span></a> 中找到。</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">example_multi_agent_prompt</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">msgs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Msg</span><span class="p">(</span><span class="s2">"system"</span><span class="p">,</span> <span class="s2">"你是一个名为 Bob 的有用助手。"</span><span class="p">,</span> <span class="s2">"system"</span><span class="p">),</span>
        <span class="n">Msg</span><span class="p">(</span><span class="s2">"Alice"</span><span class="p">,</span> <span class="s2">"嗨！"</span><span class="p">,</span> <span class="s2">"user"</span><span class="p">),</span>
        <span class="n">Msg</span><span class="p">(</span><span class="s2">"Bob"</span><span class="p">,</span> <span class="s2">"嗨！很高兴见到大家。"</span><span class="p">,</span> <span class="s2">"assistant"</span><span class="p">),</span>
        <span class="n">Msg</span><span class="p">(</span><span class="s2">"Charlie"</span><span class="p">,</span> <span class="s2">"我也是！顺便说一下，我是 Charlie。"</span><span class="p">,</span> <span class="s2">"assistant"</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">formatter</span> <span class="o">=</span> <span class="n">DashScopeMultiAgentFormatter</span><span class="p">()</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="k">await</span> <span class="n">formatter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msgs</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"格式化的提示："</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="c1"># 我们在这里打印组合用户消息的内容以便更好地理解：</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"-------------"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"组合消息"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">prompt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">"content"</span><span class="p">])</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">example_multi_agent_prompt</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>格式化的提示：
[
    {
        "role": "system",
        "content": "你是一个名为 Bob 的有用助手。"
    },
    {
        "role": "user",
        "content": "# Conversation History\nThe content between &lt;history&gt;&lt;/history&gt; tags contains your conversation history\n&lt;history&gt;\nAlice: 嗨！\nBob: 嗨！很高兴见到大家。\nCharlie: 我也是！顺便说一下，我是 Charlie。\n&lt;/history&gt;"
    }
]
-------------
组合消息
# Conversation History
The content between &lt;history&gt;&lt;/history&gt; tags contains your conversation history
&lt;history&gt;
Alice: 嗨！
Bob: 嗨！很高兴见到大家。
Charlie: 我也是！顺便说一下，我是 Charlie。
&lt;/history&gt;
</pre></div>
</div>
</section>
<section id="id4">
<h3>消息共享<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h3>
<p>在多智能体对话中，显式交换消息可能不够高效和便利，
特别是在多个智能体之间广播消息时。</p>
<p>因此，AgentScope 提供了一个名为 <code class="docutils literal notranslate"><span class="pre">MsgHub</span></code> 的异步上下文管理器来简化消息广播。
具体而言，同一个 <code class="docutils literal notranslate"><span class="pre">MsgHub</span></code> 中的智能体将自动接收其它参与者通过 <code class="docutils literal notranslate"><span class="pre">reply</span></code> 函数返回的消息。</p>
<p>下面我们构建一个多人聊天的场景，多个智能体扮演不同的角色：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">DashScopeChatModel</span><span class="p">(</span>
    <span class="n">model_name</span><span class="o">=</span><span class="s2">"qwen-max"</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"DASHSCOPE_API_KEY"</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">DashScopeMultiAgentFormatter</span><span class="p">()</span>

<span class="n">alice</span> <span class="o">=</span> <span class="n">ReActAgent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"Alice"</span><span class="p">,</span>
    <span class="n">sys_prompt</span><span class="o">=</span><span class="s2">"你是一个名为 Alice 的学生。"</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">formatter</span><span class="o">=</span><span class="n">formatter</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">bob</span> <span class="o">=</span> <span class="n">ReActAgent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"Bob"</span><span class="p">,</span>
    <span class="n">sys_prompt</span><span class="o">=</span><span class="s2">"你是一个名为 Bob 的学生。"</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">formatter</span><span class="o">=</span><span class="n">formatter</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">charlie</span> <span class="o">=</span> <span class="n">ReActAgent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"Charlie"</span><span class="p">,</span>
    <span class="n">sys_prompt</span><span class="o">=</span><span class="s2">"你是一个名为 Charlie 的学生。"</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">formatter</span><span class="o">=</span><span class="n">formatter</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">example_msghub</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""使用 MsgHub 进行多智能体对话的示例。"""</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">MsgHub</span><span class="p">(</span>
        <span class="p">[</span><span class="n">alice</span><span class="p">,</span> <span class="n">bob</span><span class="p">,</span> <span class="n">charlie</span><span class="p">],</span>
        <span class="c1"># 进入 MsgHub 时的公告消息</span>
        <span class="n">announcement</span><span class="o">=</span><span class="n">Msg</span><span class="p">(</span>
            <span class="s2">"system"</span><span class="p">,</span>
            <span class="s2">"现在大家互相认识一下，简单自我介绍。"</span><span class="p">,</span>
            <span class="s2">"system"</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">):</span>
        <span class="k">await</span> <span class="n">alice</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">bob</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">charlie</span><span class="p">()</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">example_msghub</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Alice: 大家好，我叫Alice，是一名学生。我喜欢阅读和学习新知识，也很期待与大家交流并分享彼此的兴趣爱好。希望我们能成为好朋友！
Bob: 大家好，我是Bob，也是一名学生。我对科技和计算机编程特别感兴趣，并且喜欢解决各种逻辑难题。在空闲时间，我还会打篮球保持活力。很高兴认识大家，希望我们能够共同学习成长！
Charlie: 大家好，我是Charlie，同样是一名学生。我对音乐和艺术充满热情，平时喜欢弹吉他和画画。我也非常热爱大自然，经常去远足探索自然风光。很期待与你们每一个人相识，并且希望能从我们的交流中学习到更多。让我们一起享受这段旅程吧！
</pre></div>
</div>
<p>现在我们打印 Alice 的记忆，检查她的记忆是否正确更新。</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">example_memory</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""打印 Alice 的记忆。"""</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Alice 的记忆："</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="k">await</span> <span class="n">alice</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">get_memory</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
        <span class="p">)</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">example_memory</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Alice 的记忆：
system: "现在大家互相认识一下，简单自我介绍。"
Alice: [
    {
        "id": "nV9ugWgiytksp4FNW3tfbq",
        "type": "tool_use",
        "name": "generate_response",
        "input": {
            "response": "大家好，我叫Alice，是一名学生。我喜欢阅读和学习新知识，也很期待与大家交流并分享彼此的兴趣爱好。希望我们能成为好朋友！"
        }
    }
]
system: [
    {
        "type": "tool_result",
        "id": "nV9ugWgiytksp4FNW3tfbq",
        "name": "generate_response",
        "output": [
            {
                "type": "text",
                "text": "Successfully generated response."
            }
        ]
    }
]
Alice: "大家好，我叫Alice，是一名学生。我喜欢阅读和学习新知识，也很期待与大家交流并分享彼此的兴趣爱好。希望我们能成为好朋友！"
Bob: "大家好，我是Bob，也是一名学生。我对科技和计算机编程特别感兴趣，并且喜欢解决各种逻辑难题。在空闲时间，我还会打篮球保持活力。很高兴认识大家，希望我们能够共同学习成长！"
Charlie: "大家好，我是Charlie，同样是一名学生。我对音乐和艺术充满热情，平时喜欢弹吉他和画画。我也非常热爱大自然，经常去远足探索自然风光。很期待与你们每一个人相识，并且希望能从我们的交流中学习到更多。让我们一起享受这段旅程吧！"
</pre></div>
</div>
</section>
</section>
<section id="id5">
<h2>进一步阅读<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="task_prompt.html#prompt"><span class="std std-ref">提示词格式化</span></a></p></li>
<li><p><a class="reference internal" href="task_pipeline.html#pipeline"><span class="std std-ref">管道 (Pipeline)</span></a></p></li>
</ul>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 10.127 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-tutorial-workflow-conversation-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/6fc2f5ac2a455c83476d717ce963aa17/workflow_conversation.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">workflow_conversation.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/6b0487392b60d378c204104fbd55f37b/workflow_conversation.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">workflow_conversation.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../_downloads/18fe00449a86bd36f4433460cb4d1a54/workflow_conversation.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">workflow_conversation.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>

        