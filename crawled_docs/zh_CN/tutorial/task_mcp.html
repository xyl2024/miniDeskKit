<!-- Title: MCP - AgentScope -->
<!-- URL: https://doc.agentscope.io/zh_CN/tutorial/task_mcp.html -->

          <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">备注</p>
<p><a class="reference internal" href="#sphx-glr-download-tutorial-task-mcp-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="mcp">
<span id="sphx-glr-tutorial-task-mcp-py"></span><span id="id1"></span><h1>MCP<a class="headerlink" href="#mcp" title="Link to this heading">¶</a></h1>
<p>本章将介绍 AgentScope 对 MCP（Model Context Protocol）的以下支持：</p>
<ul class="simple">
<li><p>支持 <strong>HTTP</strong> （StreamableHTTP 和 SSE）和 <strong>StdIO</strong> 类型的 MCP 服务器</p></li>
<li><p>提供 <strong>有状态</strong> 和 <strong>无状态</strong> 两种 MCP 客户端</p></li>
<li><p>提供 <strong>MCP 级别</strong> 和 <strong>函数级别</strong> 的 MCP 工具管理</p></li>
</ul>
<p>这里的有状态/无状态是指客户端是否会维持与 MCP 服务器的会话（session）。
无状态客户端只会在调用工具发生时建立会话，并在工具调用结束后立即销毁会话，是一种轻量化的使用方式。</p>
<p>下表总结了支持的 MCP 客户端类型和协议：</p>
<div class="table-wrapper docutils container" id="id7">
<table class="docutils align-default" id="id7">
<caption><span class="caption-text">支持的 MCP 客户端类型和协议</span><a class="headerlink" href="#id7" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>客户端类型</p></th>
<th class="head"><p>HTTP（StreamableHTTP 和 SSE）</p></th>
<th class="head"><p>StdIO</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>有状态客户端</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">HttpStatefulClient</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">StdIOStatefulClient</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>无状态客户端</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">HttpStatelessClient</span></code></p></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.mcp</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpStatefulClient</span><span class="p">,</span> <span class="n">HttpStatelessClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope.tool</span><span class="w"> </span><span class="kn">import</span> <span class="n">Toolkit</span>
</pre></div>
</div>
<section id="id2">
<h2>MCP 客户端<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<p>在 AgentScope 中，MCP 客户端负责</p>
<ul class="simple">
<li><p>连接到 MCP 服务器，</p></li>
<li><p>从服务器获取工具函数，以及</p></li>
<li><p>调用 MCP 服务器中的工具函数。</p></li>
</ul>
<p>AgentScope 中有两种类型的 MCP 客户端：<strong>有状态</strong> 和 <strong>无状态</strong>。
它们仅在 <strong>如何管理与 MCP 服务器的会话</strong> 方面有所不同。</p>
<ul class="simple">
<li><p>有状态客户端：有状态 MCP 客户端在其生命周期内 <strong>维持与 MCP 服务器的持久会话</strong>。开发者应显式调用 <code class="docutils literal notranslate"><span class="pre">connect()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">close()</span></code> 方法来管理会话的生命周期。</p></li>
<li><p>无状态客户端：无状态 MCP 客户端在调用工具函数时创建新会话，在工具函数调用完成后立即销毁会话，更加轻量化。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<ul class="simple">
<li><p>StdIO MCP 服务器只有有状态客户端，当调用 <code class="docutils literal notranslate"><span class="pre">connect()</span></code> 时，它将在本地启动 MCP 服务器然后连接到它。</p></li>
<li><p>对于有状态客户端，开发者必须确保在调用工具函数时客户端已连接。</p></li>
<li><p>当有多个 <cite>HttpStatefulClient</cite> 或 <cite>StdIOStatefulClient</cite> 建立连接时，应按照后进先出 (LIFO) 的顺序关闭它们以避免引发错误。</p></li>
</ul>
</div>
<p>以高德地图 MCP 服务器为例，有状态和无状态客户端的创建非常相似：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">stateful_client</span> <span class="o">=</span> <span class="n">HttpStatefulClient</span><span class="p">(</span>
    <span class="c1"># 用于标识 MCP 的名称</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"mcp_services_stateful"</span><span class="p">,</span>
    <span class="n">transport</span><span class="o">=</span><span class="s2">"streamable_http"</span><span class="p">,</span>
    <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">"https://mcp.amap.com/mcp?key=</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'GAODE_API_KEY'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">stateless_client</span> <span class="o">=</span> <span class="n">HttpStatelessClient</span><span class="p">(</span>
    <span class="c1"># 用于标识 MCP 的名称</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"mcp_services_stateless"</span><span class="p">,</span>
    <span class="n">transport</span><span class="o">=</span><span class="s2">"streamable_http"</span><span class="p">,</span>
    <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">"https://mcp.amap.com/mcp?key=</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'GAODE_API_KEY'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>有状态和无状态客户端都提供以下方法：</p>
<div class="table-wrapper docutils container" id="id8">
<table class="docutils align-default" id="id8">
<caption><span class="caption-text">MCP 客户端方法</span><a class="headerlink" href="#id8" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>方法</p></th>
<th class="head"><p>描述</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">list_tools</span></code></p></td>
<td><p>列出 MCP 服务器中所有可用的工具。</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">get_callable_function</span></code></p></td>
<td><p>通过名称从 MCP 服务器获取可调用的函数对象。</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="id3">
<h2>MCP 作为工具<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p>AgentScope 提供了对 MCP 工具的细粒度管理，包括 MCP 级别和函数级别的管理。</p>
<section id="id4">
<h3>MCP 级别管理<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h3>
<p>您可以将 MCP 服务器的所有工具一次性注册到 <code class="docutils literal notranslate"><span class="pre">Toolkit</span></code> 中，如下所示。</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>可选地，开发者可以通过指定组名来管理工具。有关分组工具管理，请参考 <a class="reference internal" href="task_tool.html#tool"><span class="std std-ref">工具</span></a> 部分。</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">toolkit</span> <span class="o">=</span> <span class="n">Toolkit</span><span class="p">()</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">example_register_stateless_mcp</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""注册无状态客户端 MCP 工具的示例。"""</span>
    <span class="c1"># 从 MCP 服务器注册所有工具</span>
    <span class="k">await</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">register_mcp_client</span><span class="p">(</span>
        <span class="n">stateless_client</span><span class="p">,</span>
        <span class="c1"># group_name="map_services",  # 可选的组名</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"注册的 MCP 工具总数："</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">get_json_schemas</span><span class="p">()))</span>

    <span class="n">maps_geo</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
        <span class="n">tool</span>
        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">get_json_schemas</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tool</span><span class="p">[</span><span class="s2">"function"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"maps_geo"</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">示例 ``maps_geo`` 函数："</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="n">maps_geo</span><span class="p">,</span>
            <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">example_register_stateless_mcp</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>注册的 MCP 工具总数： 15

示例 ``maps_geo`` 函数：
{
    "type": "function",
    "function": {
        "name": "maps_geo",
        "description": "将详细的结构化地址转换为经纬度坐标。支持对地标性名胜景区、建筑物名称解析为经纬度坐标",
        "parameters": {
            "type": "object",
            "properties": {
                "address": {
                    "type": "string",
                    "description": "待解析的结构化地址信息"
                },
                "city": {
                    "type": "string",
                    "description": "指定查询的城市"
                }
            },
            "required": [
                "address"
            ]
        }
    }
}
</pre></div>
</div>
<p>要移除已注册的工具，可以使用 <code class="docutils literal notranslate"><span class="pre">remove_tool_function</span></code> 函数，或使用 <code class="docutils literal notranslate"><span class="pre">remove_mcp_clients</span></code> 移除特定 MCP 的所有工具。</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">example_remove_mcp_tools</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""移除 MCP 工具的示例。"""</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"移除前的工具总数："</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">get_json_schemas</span><span class="p">()))</span>

    <span class="c1"># 通过名称移除特定的工具函数</span>
    <span class="n">toolkit</span><span class="o">.</span><span class="n">remove_tool_function</span><span class="p">(</span><span class="s2">"maps_geo"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"工具数量："</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">get_json_schemas</span><span class="p">()))</span>

    <span class="c1"># 通过名称移除 MCP 客户端的所有工具</span>
    <span class="k">await</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">remove_mcp_clients</span><span class="p">(</span><span class="n">client_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"mcp_services_stateless"</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"工具数量："</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">get_json_schemas</span><span class="p">()))</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">example_remove_mcp_tools</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>移除前的工具总数： 15
工具数量： 14
工具数量： 0
</pre></div>
</div>
</section>
<section id="id5">
<h3>函数级别管理<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h3>
<p>注意到开发者有对 MCP 工具进行更细粒度控制的需求，例如对工具结果进行后处理，或使用它们创建更复杂的工具函数。</p>
<p>因此，AgentScope 支持通过工具名从 MCP 客户端获取可调用的函数对象，这样开发者可以</p>
<ul class="simple">
<li><p>直接调用它，</p></li>
<li><p>将其包装到自己的函数中，或以任何其它方式进行使用。</p></li>
</ul>
<p>此外，开发者可以指定是否将工具函数执行结果包装成 <code class="docutils literal notranslate"><span class="pre">ToolResponse</span></code> 对象，以便与 <code class="docutils literal notranslate"><span class="pre">Toolkit</span></code> 无缝使用。
如果设置 <code class="docutils literal notranslate"><span class="pre">wrap_tool_result=False</span></code>，将返回原始结果类型 <code class="docutils literal notranslate"><span class="pre">mcp.types.CallToolResult</span></code>。</p>
<p>以 <code class="docutils literal notranslate"><span class="pre">maps_geo</span></code> 函数为例，可以将其获取为可调用的函数对象，如下所示：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">example_function_level_usage</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""使用函数级别 MCP 工具的示例。"""</span>
    <span class="n">func_obj</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stateless_client</span><span class="o">.</span><span class="n">get_callable_function</span><span class="p">(</span>
        <span class="n">func_name</span><span class="o">=</span><span class="s2">"maps_geo"</span><span class="p">,</span>
        <span class="c1"># 是否将工具结果包装到 AgentScope 的 ToolResponse 中</span>
        <span class="n">wrap_tool_result</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 您可以获取其名称、描述和 JSON schema</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"函数名称："</span><span class="p">,</span> <span class="n">func_obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"函数描述："</span><span class="p">,</span> <span class="n">func_obj</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">"函数 JSON schema："</span><span class="p">,</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">func_obj</span><span class="o">.</span><span class="n">json_schema</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># 直接调用函数对象</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">func_obj</span><span class="p">(</span>
        <span class="n">address</span><span class="o">=</span><span class="s2">"天安门广场"</span><span class="p">,</span>
        <span class="n">city</span><span class="o">=</span><span class="s2">"北京"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">函数调用结果："</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">example_function_level_usage</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>函数名称： maps_geo
函数描述： 将详细的结构化地址转换为经纬度坐标。支持对地标性名胜景区、建筑物名称解析为经纬度坐标
函数 JSON schema： {
    "type": "function",
    "function": {
        "name": "maps_geo",
        "description": "将详细的结构化地址转换为经纬度坐标。支持对地标性名胜景区、建筑物名称解析为经纬度坐标",
        "parameters": {
            "type": "object",
            "properties": {
                "address": {
                    "type": "string",
                    "description": "待解析的结构化地址信息"
                },
                "city": {
                    "type": "string",
                    "description": "指定查询的城市"
                }
            },
            "required": [
                "address"
            ]
        }
    }
}

函数调用结果：
ToolResponse(content=[{'type': 'text', 'text': '{"results":[{"country":"中国","province":"北京市","city":"北京市","citycode":"010","district":"东城区","street":[],"number":[],"adcode":"110101","location":"116.397755,39.903182","level":"兴趣点"}]}'}], metadata=None, stream=False, is_last=True, is_interrupted=False, id='2025-10-03 14:51:05.187_9ff062')
</pre></div>
</div>
</section>
</section>
<section id="id6">
<h2>进一步阅读<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h2>
<p>有关更多详细信息，请参见：</p>
<ul class="simple">
<li><p><a class="reference internal" href="task_tool.html#tool"><span class="std std-ref">工具</span></a></p></li>
<li><p><a class="reference internal" href="task_agent.html#agent"><span class="std std-ref">智能体</span></a></p></li>
</ul>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 6.827 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-tutorial-task-mcp-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/da545788627514321d5d0429de9a0028/task_mcp.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">task_mcp.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/5b635b97c42d0920f13f83fb1a04edb9/task_mcp.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">task_mcp.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../_downloads/f5b9b10da36a9220659ec2699021ef32/task_mcp.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">task_mcp.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>

        